function Geolocator(a){this.status=-1,this.error="",a&&(this.options=a||{},this.options.positionOptions=a.positionOptions||{},this.options.error=a.error||{},this.options.positionOptions={enableHighAccuracy:a.positionOptions.enableHighAccuracy||!0,maximumAge:a.positionOptions.maximumAge||0},this.watcher={count:0,first:{},last:{},id:null},this.moving={status:!1,speed:0,bearing:[],waypoints:[],check:0,getDistance:function(){for(var a=0,b=1;b<this.waypoints.length;b++)a+=parseFloat(calculateDistance(this.waypoints[b-1].position.coords.latitude,this.waypoints[b-1].position.coords.longitude,this.waypoints[b].position.coords.latitude,this.waypoints[b].position.coords.longitude));return a},getAveSpeed:function(){for(var a,b,c=0,d=parseFloat(0),e=1;e<this.waypoints.length;e++)"undefined"!=typeof this.waypoints[e].speed&&this.waypoints[e].speed>0&&(d+=parseFloat(this.waypoints[e].speed),c++);return this.getCompleteTime()>0&&(b=this.getDistance()/(this.getCompleteTime()/1e3/60/60),a=parseFloat(calculateDistance(this.waypoints[0].position.coords.latitude,this.waypoints[0].position.coords.longitude,this.waypoints[this.waypoints.length-1].position.coords.latitude,this.waypoints[this.waypoints.length-1].position.coords.longitude))/(this.getCompleteTime()/1e3/60/60)),c>0?(d/c+b+a)/3:0},getCompleteTime:function(){return this.waypoints[this.waypoints.length-1].position.timestamp-this.waypoints[0].position.timestamp}},this.init())}function calculateDistance(a,b,c,d){var e=6371,f=(c-a).toRad(),g=(d-b).toRad(),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(a.toRad())*Math.cos(c.toRad())*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),j=e*i;return j}function bearingTo(a,b,c,d){var e=a.toRad(),f=c.toRad(),g=(d-b).toRad(),h=Math.sin(g)*Math.cos(f),i=Math.cos(e)*Math.sin(f)-Math.sin(e)*Math.cos(f)*Math.cos(g),j=Math.atan2(h,i);return(j.toDeg()+360)%360}Geolocator.prototype.init=function(){navigator.geolocation?(this.status=1,this.watcher.id=this.addWatcher(this.collectData),this.status=2):(this.status=0,"function"==typeof this.options.error.posUnavailable&&this.options.error.posUnavailable(error))},Geolocator.prototype.addWatcher=function(a,b){var c=this;return navigator.geolocation?("function"==typeof c.options.callbacks.start&&c.options.callbacks.start(),navigator.geolocation.watchPosition(function(b){a(b,c)},function(a){switch(c.error=a,a.code){case 1:"function"==typeof c.options.error.pmDenied&&c.options.error.pmDenied(a);break;case 2:"function"==typeof c.options.error.posUnavailable&&c.options.error.posUnavailable(a);break;case 3:"function"==typeof c.options.error.posUnavailable&&c.options.error.posUnavailable(a)}"function"==typeof c.options.error.default&&c.options.error.default(a)},c.options.positionOptions)):(c.status=0,void("function"==typeof c.options.error.posUnavailable&&c.options.error.posUnavailable(error)))},Geolocator.prototype.collectData=function(a,b){var c=0;if(b.watcher.count>0){var d=Number(calculateDistance(b.watcher.last.coords.latitude,b.watcher.last.coords.longitude,a.coords.latitude,a.coords.longitude)).toFixed(6),e=Number((a.timestamp-b.watcher.last.timestamp)/1e3).toFixed(6);e=e/60/60,e&&(c=d/e,b.moving.speed=c);var f=bearingTo(b.watcher.last.coords.latitude,b.watcher.last.coords.longitude,a.coords.latitude,a.coords.longitude);b.moving.waypoints[b.watcher.count]={position:a,distance:d,time:e,speed:c,bearing:f},console.log(typeof b.options.callbacks.step),"function"==typeof b.options.callbacks.step&&b.options.callbacks.step(b.moving.waypoints)}else b.watcher.first=a,b.watcher.last=a,b.moving.waypoints[b.watcher.count]={position:a},"function"==typeof b.options.callbacks.position&&b.options.callbacks.position(a);b.checkMoving(),b.last=a,b.watcher.count++},Geolocator.prototype.checkMoving=function(a){if(0===this.moving.check){var b=this,c=0,e=(Date.now(),0);this.moving.check=2;var f=setInterval(function(){e=b.getBearingMax(),7===c++&&(b.moving.getDistance()>0&&e>0&&e<30?("function"==typeof b.options.callbacks.isMoving&&b.options.callbacks.isMoving(b.moving),b.moving.status=1):("function"==typeof b.options.callbacks.isStandStill&&b.options.callbacks.isStandStill(b.moving),b.moving.status=0),b.moving.check=1,navigator.geolocation.clearWatch(b.watcher.id),clearInterval(f))},500)}return 2},Geolocator.prototype.getBearingMax=function(){for(var a=0,b=1;b<this.moving.waypoints.length;b++)if(this.moving.waypoints[b-1].bearing>0){var c=Math.abs(this.moving.waypoints[b-1].bearing-this.moving.waypoints[b].bearing);c>0&&c>a&&(a=c)}return a},Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return this*(180/Math.PI)};
