function Geolocator(a){if(!a)throw"Specify callbacks";this.status=-1,this.error="",this.options=a||{},this.options.positionOptions=a.positionOptions||{},this.options.error=a.error||{},this.options.positionOptions={enableHighAccuracy:a.positionOptions.enableHighAccuracy||!0,maximumAge:a.positionOptions.maximumAge||0},this.watcher={count:0,first:{},last:{},id:null},this.moving={status:!1,speed:0,bearing:[],waypoints:[],check:0,getDistance:function(){for(var a=0,b=1;b<this.waypoints.length;b++)a+=parseFloat(calculateDistance(this.waypoints[b-1].position.coords.latitude,this.waypoints[b-1].position.coords.longitude,this.waypoints[b].position.coords.latitude,this.waypoints[b].position.coords.longitude));return a},getAveSpeed:function(){for(var a,b,c=0,d=parseFloat(0),e=1;e<this.waypoints.length;e++)"undefined"!=typeof this.waypoints[e].speed&&this.waypoints[e].speed>0&&(d+=parseFloat(this.waypoints[e].speed),c++);return this.getCompleteTime()>0&&(b=this.getDistance()/(this.getCompleteTime()/1e3/60/60),a=parseFloat(calculateDistance(this.waypoints[0].position.coords.latitude,this.waypoints[0].position.coords.longitude,this.waypoints[this.waypoints.length-1].position.coords.latitude,this.waypoints[this.waypoints.length-1].position.coords.longitude))/(this.getCompleteTime()/1e3/60/60)),c>0?(d/c+b+a)/3:0},getCompleteTime:function(){return this.waypoints[this.waypoints.length-1].position.timestamp-this.waypoints[0].position.timestamp}},this.init()}function calculateDistance(a,b,c,d){var e=6371,f=(c-a).toRad(),g=(d-b).toRad(),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(a.toRad())*Math.cos(c.toRad())*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));return e*i}function bearingTo(a,b,c,d){var e=a.toRad(),f=c.toRad(),g=(d-b).toRad(),h=Math.sin(g)*Math.cos(f),i=Math.cos(e)*Math.sin(f)-Math.sin(e)*Math.cos(f)*Math.cos(g),j=Math.atan2(h,i);return(j.toDeg()+360)%360}Geolocator.prototype.init=function(){var a=this;navigator.geolocation?(this.status=1,this.options.callbacks.isMoving||this.options.callbacks.isStandStill||this.options.callbacks.stepWatching?(this.watcher.id=this.addWatcher(this.collectData.bind(this)),this.status=2):this.options.callbacks.position&&("function"==typeof a.options.callbacks.start&&a.options.callbacks.start(),navigator.geolocation.getCurrentPosition(function(b){a.watcher.first=b,a.watcher.last=b,a.moving.waypoints[a.watcher.count]={position:b},"function"==typeof a.options.callbacks.position&&a.options.callbacks.position(b),"function"==typeof a.options.callbacks.ready&&a.options.callbacks.ready(b)},function(b){a.handleError(b)}))):(this.status=0,"function"==typeof this.options.error.posUnavailable&&this.options.error.posUnavailable(error))},Geolocator.prototype.addWatcher=function(a,b){var c=this;return"function"==typeof c.options.callbacks.start&&c.options.callbacks.start(),"function"==typeof c.options.callbacks.startWatching&&c.options.callbacks.startWatching(),navigator.geolocation.watchPosition(function(b){a(b,c)},function(a){c.handleError(a)},c.options.positionOptions)},Geolocator.prototype.handleError=function(a){switch(this.error=a,a.code){case 1:"function"==typeof this.options.error.pmDenied&&this.options.error.pmDenied(a);break;case 2:"function"==typeof this.options.error.posUnavailable&&this.options.error.posUnavailable(a);break;case 3:"function"==typeof this.options.error.posUnavailable&&this.options.error.posUnavailable(a)}"function"==typeof this.options.error.default&&this.options.error.default(a),"function"==typeof this.options.callbacks.ready&&this.options.callbacks.ready(pos)},Geolocator.prototype.collectData=function(a){var b=0;if(this.watcher.count>0){var c=Number(calculateDistance(this.watcher.last.coords.latitude,this.watcher.last.coords.longitude,a.coords.latitude,a.coords.longitude)).toFixed(6),d=Number((a.timestamp-this.watcher.last.timestamp)/1e3).toFixed(6);d=d/60/60,d&&(b=c/d,this.moving.speed=b);var e=bearingTo(this.watcher.last.coords.latitude,this.watcher.last.coords.longitude,a.coords.latitude,a.coords.longitude);this.moving.waypoints[this.watcher.count]={position:a,distance:c,time:d,speed:b,bearing:e},"function"==typeof this.options.callbacks.stepWatching&&this.options.callbacks.stepWatching(this.moving.waypoints)}else this.watcher.first=a,this.watcher.last=a,this.moving.waypoints[this.watcher.count]={position:a},"function"==typeof this.options.callbacks.position&&this.options.callbacks.position(a);this.checkMoving(),this.last=a,this.watcher.count++},Geolocator.prototype.checkMoving=function(a){if(0===this.moving.check){var b=this,c=0,e=(Date.now(),0);this.moving.check=2;var f=setInterval(function(){e=b.getBearingMax(),7===c++&&(b.moving.getDistance()>0&&e>0&&e<30?("function"==typeof b.options.callbacks.isMoving&&b.options.callbacks.isMoving(b.moving),b.moving.status=1):("function"==typeof b.options.callbacks.isStandStill&&b.options.callbacks.isStandStill(b.moving),b.moving.status=0),b.moving.check=1,navigator.geolocation.clearWatch(b.watcher.id),"function"==typeof b.options.callbacks.stoppedWatching&&b.options.callbacks.stoppedWatching(),"function"==typeof b.options.callbacks.ready&&b.options.callbacks.ready(),clearInterval(f))},500)}return 2},Geolocator.prototype.getBearingMax=function(){for(var a=0,b=1;b<this.moving.waypoints.length;b++)if(this.moving.waypoints[b-1].bearing>0){var c=Math.abs(this.moving.waypoints[b-1].bearing-this.moving.waypoints[b].bearing);c>0&&c>a&&(a=c)}return a},Number.prototype.toRad=function(){return this*Math.PI/180},Number.prototype.toDeg=function(){return this*(180/Math.PI)};
